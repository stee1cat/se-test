# Visits counter without database with PHP

## Task

**Задание:** Реализовать счетчик вызова скрипта. Было принято решение, хранить данные в файле.

```php
<?php

file_put_contents("./counter.txt", file_get_contents("./counter.txt") + 1);
```

**Вопрос:** Какие проблемы имеет данные подход? Как вы их можете решить? (Нельзя использовать другие технологии)

**Дополнительный вопрос:** Через некоторое время нагрузка на сервер значительно выросла. Какие проблемы вы видите? Как вы их можете решить? Если бы вы могли выбрать другую технологию, то какую и почему?

## Result

Указанный пример кода не выполняет операцию увеличения счётчика атомарно. Между операцией чтения и записи нового значения, может изменится значение счётчика в файле `counter.txt` по сравнению с первоначальным (например, в это время пришёл второй запрос). Эту проблему можно решить несколькими путями:

1. Использовать эксклюзивную блокировку на запись.

```php
<?php

$fileName = 'counter.txt';
$handle = fopen($fileName, 'r+');
$fileSize = filesize($fileName);

while (!flock($handle, LOCK_EX)) {
    // Тут логичнее не ждать освобождения блокировки,
    // а создавать новый файл со счётчиком или находить раннее
    // созданный доступный для записи и увеличивать в нём
    // счетчик.
    // Далее когда нужно считать сумму, беря данные из всех
    // файлов. Тем самым мы не будет терять время на пустые
    // ожидания.
}

$counter = (int) fread($handle, $fileSize);
$counter++;

ftruncate($handle, 0);
fwrite($handle, $counter);
fflush($handle);
flock($handle, LOCK_UN);

fclose($handle);
```

2. Использовать какую-то либо БД (memcached, Redis) для хранения счётчика. Плюс этого решения в том, что при увеличении нагрузки мы можем масштабировать наше приложение горизонтально путём добавления новых серверов, а не наращивания ресурсов одного существующего. Первый вариант решения более требователен к дисковым IO.
